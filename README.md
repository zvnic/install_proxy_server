# Настройка прокси-сервера (HTTP и SOCKS5)

Этот проект позволяет развернуть HTTP и SOCKS5 прокси-сервер на Ubuntu с использованием Docker, Squid (для HTTP/HTTPS) и Dante (для SOCKS5). Настройка автоматизирована с помощью Makefile, который конфигурирует сервисы, открывает порты в брандмауэре и создает файл с учетными данными для доступа к прокси.

## Возможности
- **HTTP-прокси**: Доступ через `http://<пользователь>:<пароль>@<IP_СЕРВЕРА>:<ПОРТ_HTTP>`
- **SOCKS5-прокси**: Доступ через `socks5://<пользователь>:<пароль>@<IP_СЕРВЕРА>:<ПОРТ_SOCKS>`
- Аутентификация по имени пользователя и паролю.
- Настраиваりがемые порты для HTTP и SOCKS5.
- Автоматическая настройка брандмауэра с использованием `ufw`.
- Создание файла `proxy_credentials.txt` с данными для доступа к прокси.

## Требования
- Сервер с Ubuntu (рекомендуется 18.04 или новее).
- Доступ с правами root или sudo.
- Подключение к интернету для загрузки Docker-образов и зависимостей.
- Свободные порты для HTTP (по умолчанию: 3128) и SOCKS5 (по умолчанию: 1080).

## Установка и настройка

### 1. Создайте директорию проекта
Создайте директорию для проекта и сохраните в нее предоставленный `Makefile`:
```bash
mkdir proxy-server-project
cd proxy-server-project
# Сохраните Makefile в этой директории
```

### 2. Запустите настройку
Выполните следующую команду для запуска процесса настройки:
```bash
make prompt all
```

Это действие:
- Запросит порты для HTTP и SOCKS5 (нажмите Enter, чтобы использовать значения по умолчанию: 3128 для HTTP, 1080 для SOCKS5).
- Установит зависимости (`docker`, `docker-compose`, `apache2-utils`, `curl`, `ufw`), если они еще не установлены.
- Создаст файлы конфигурации в поддиректории `proxy-server`.
- Запустит Docker-контейнеры для Squid (HTTP) и Dante (SOCKS5).
- Настроит брандмауэр (`ufw`), открыв указанные порты.
- Сгенерирует файл `proxy_credentials.txt` с данными для доступа.

### 3. Проверьте результат
После выполнения команды проверьте содержимое файла `proxy_credentials.txt`:
```bash
cat proxy_credentials.txt
```

Пример вывода:
```
http://proxyuser:proxypass@<IP_СЕРВЕРА>:3128
socks5://proxyuser:proxypass@<IP_СЕРВЕРА>:1080
```

Если в файле указано `YOUR_SERVER_IP`, замените его на публичный IP вашего сервера.

## Использование прокси
Используйте данные из `proxy_credentials.txt` для настройки приложений или инструментов для работы через прокси.

- **HTTP-прокси**:
  - Формат: `http://proxyuser:proxypass@<IP_СЕРВЕРА>:<ПОРТ_HTTP>`
  - Пример использования с `curl`:
    ```bash
    curl --proxy http://proxyuser:proxypass@<IP_СЕРВЕРА>:3128 https://example.com
    ```

- **SOCKS5-прокси**:
  - Формат: `socks5://proxyuser:proxypass@<IP_СЕРВЕРА>:<ПОРТ_SOCKS>`
  - Пример использования с `curl`:
    ```bash
    curl --socks5-hostname socks5://proxyuser:proxypass@<IP_СЕРВЕРА>:1080 https://example.com
    ```

## Проверка статуса прокси
- Убедитесь, что контейнеры запущены:
  ```bash
  docker ps
  ```
  Вы должны увидеть контейнеры `squid_proxy` и `dante_proxy`.

- Проверьте логи контейнеров на наличие ошибок:
  ```bash
  docker logs squid_proxy
  docker logs dante_proxy
  ```

- Проверьте правила брандмауэра:
  ```bash
  sudo ufw status
  ```
  Убедитесь, что указанные порты (например, 3128, 1080) разрешены (`ALLOW`).

## Очистка
Чтобы остановить прокси-сервисы, удалить конфигурации и закрыть порты в брандмауэре:
```bash
make clean
```

Это действие:
- Остановит и удалит Docker-контейнеры.
- Удалит директорию `proxy-server` и файл `proxy_credentials.txt`.
- Удалит правила брандмауэра для указанных портов.

## Устранение неполадок
- **Конфликт портов**:
  - Если указанные порты (например, 3128 или 1080) уже заняты:
    ```bash
    sudo netstat -tuln | grep -E '3128|1080'
    ```
    Выберите другие порты при запросе в `make prompt`.

- **Конфликт имен контейнеров**:
  - Если контейнеры `squid_proxy` или `dante_proxy` уже существуют:
    ```bash
    docker rm -f squid_proxy dante_proxy
    ```
    Затем повторно выполните `make prompt all`.

- **Неверный IP в `proxy_credentials.txt`**:
  - Если указано `YOUR_SERVER_IP`, вручную отредактируйте `proxy_credentials.txt`, указав публичный IP сервера, или проверьте IP:
    ```bash
    curl -s ifconfig.me
    ```

- **Брандмауэр блокирует доступ**:
  - Убедитесь, что `ufw` разрешает порты прокси и SSH (порт 22), чтобы избежать блокировки:
    ```bash
    sudo ufw allow 22
    sudo ufw status
    ```

- **Docker не запускается**:
  - Проверьте статус службы Docker:
    ```bash
    sudo systemctl status docker
    ```
    Перезапустите при необходимости:
    ```bash
    sudo systemctl restart docker
    ```

## Рекомендации по безопасности
- Измените имя пользователя (`proxyuser`) и пароль (`proxypass`) в `Makefile` для повышения безопасности.
- Ограничьте доступ к портам прокси для определенных IP-адресов с помощью `ufw`:
  ```bash
  sudo ufw allow from <РАЗРЕШЕННЫЙ_IP> to any port <ПОРТ>
  ```
- Регулярно проверяйте логи на попытки несанкционированного доступа.

## Настройка
- **Изменение портов**: Отредактируйте значения по умолчанию `HTTP_PORT` и `SOCKS_PORT` в `Makefile` или укажите свои порты при выполнении `make prompt`.
- **Изменение учетных данных**: Измените переменные `USER` и `PASS` в `Makefile`.
- **Добавление пользователей**: Добавьте дополнительных пользователей в файлы `proxy-server/squid.passwd` и `proxy-server/dante.passwd` вручную.

Для дополнительной помощи обратитесь к администратору или документации Squid и Dante.
